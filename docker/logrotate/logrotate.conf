# Logrotate configuration for PanelTK application
# This configuration manages log rotation for all application components

# Global options
weekly
rotate 52
create
compress
delaycompress
missingok
notifempty
copytruncate
dateext
dateformat -%Y%m%d-%s

# Nginx logs
/var/log/nginx/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 www-data www-data
    postrotate
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}

# Application logs
/var/log/panel-tk/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 paneltk paneltk
    postrotate
        # Restart application if using systemd
        systemctl reload panel-tk || true
    endscript
}

# Database logs
/var/log/postgresql/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 postgres postgres
    postrotate
        # Reload PostgreSQL configuration
        /usr/bin/pg_ctl reload -D /var/lib/postgresql/data || true
    endscript
}

# Redis logs
/var/log/redis/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 redis redis
    postrotate
        # Reload Redis configuration
        redis-cli CONFIG REWRITE || true
    endscript
}

# Prometheus logs
/var/log/prometheus/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 prometheus prometheus
    postrotate
        # Send SIGHUP to Prometheus for log rotation
        pkill -HUP prometheus || true
    endscript
}

# System logs
/var/log/syslog {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    postrotate
        invoke-rc.d rsyslog rotate > /dev/null
    endscript
}

# Docker container logs
/var/lib/docker/containers/*/*-json.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    maxsize 100M
    postrotate
        # Restart Docker containers to close log files
        docker ps -q | xargs -r docker kill -s HUP || true
    endscript
}

# Custom application logs
/opt/panel-tk/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 paneltk paneltk
    maxsize 50M
}

# Security logs
/var/log/auth.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 root root
}

# Mail logs
/var/log/mail.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 syslog adm
}

# Cron logs
/var/log/cron.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
}

# Special handling for large log files
/var/log/large-app/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    maxsize 500M
    create 0644 paneltk paneltk
    postrotate
        # Custom script to handle large log rotation
        /opt/panel-tk/scripts/handle-large-logs.sh || true
    endscript
}

# Emergency rotation for disk space issues
/var/log/emergency/*.log {
    hourly
    rotate 24
    compress
    delaycompress
    missingok
    notifempty
    maxsize 10M
    create 0644 root root
    postrotate
        # Emergency cleanup if disk space is low
        df -h / | awk 'NR==2 {if ($5+0 > 90) system("find /var/log -name \"*.log\" -mtime +1 -delete")}'
    endscript
}
